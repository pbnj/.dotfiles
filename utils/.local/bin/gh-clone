#!/bin/bash

set -euo pipefail

GH_ORG="${1:-$(gh org list | awk '{print $1}')}"
CACHE_FILE="/tmp/gh_repo_list_${GH_ORG}"
INITIAL_QUERY="${1:-}"

CACHE_REPOS="gh repo list --no-archived --limit 1000 --json nameWithOwner --jq .[].nameWithOwner \"${GH_ORG}\" >\"${CACHE_FILE}\""
LOAD_REPOS="cat ${CACHE_FILE}"

fzf-tmux \
  -p '80%' \
  --reverse \
  --bind "start:reload:${LOAD_REPOS}" \
  --bind "ctrl-r:reload(${CACHE_REPOS}; ${LOAD_REPOS})" \
  --query "${INITIAL_QUERY}" \
  --prompt "gh repo clone ${GH_ORG}> " |
  xargs -t -I{} gh repo clone {} "${HOME}/Projects/github.com/{}" || true
