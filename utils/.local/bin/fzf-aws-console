#!/bin/bash

set -euo pipefail
[[ "${DEBUG:-}" == "true" ]] && set -x

aws configure list-profiles |
  grep -E '^\d{12}' |
  awk -F/ 'NR==1 {print "ID","ALIAS","ROLE"} {print $1,$2,$3}' |
  column -t |
  fzf \
  --tmux "center,80%" \
  --reverse \
  --input-border \
  --query "${1:-}" \
  --header "CTRL-I: copy id / CTRL-A: copy account alias / CTRL-Y: copy id & alias / CTRL-U: copy url to clipboard / ENTER: open in browser" \
  --header-lines 1 \
  --header-border "bottom" \
  --bind "ctrl-i:become:awk '{printf(\"%s\",\$1)}' <<<{} | pbcopy" \
  --bind "ctrl-a:become:awk '{printf(\"%s\",\$2)}' <<<{} | pbcopy" \
  --bind "ctrl-y:become:awk '{printf(\"%s %s\",\$1,\$2)}' <<<{} | pbcopy" \
  --bind "ctrl-u:become:echo {} | awk '{print \"$AWS_SSO_ACCESS_PORTAL_URL/console?account_id=\"\$1\"&role_name=\"\$3}' | pbcopy" \
  --bind "enter:become:echo {} | awk '{print \"$AWS_SSO_ACCESS_PORTAL_URL/console?account_id=\"\$1\"&role_name=\"\$3}' | xargs -t open" \
  --prompt "AWS Profile> " || true
